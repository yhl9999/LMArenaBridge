name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  lint-and-type-check:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy pyright black isort

      - name: Run Ruff linter
        run: |
          echo "=== Running Ruff Linter ==="
          ruff check src/ tests/ || true
        continue-on-error: true

      - name: Check code formatting with Black
        run: |
          echo "=== Checking Code Formatting ==="
          black --check --diff src/ tests/ || true
        continue-on-error: true

      - name: Check import sorting with isort
        run: |
          echo "=== Checking Import Sorting ==="
          isort --check-only --diff src/ tests/ || true
        continue-on-error: true

      - name: Run mypy type checker
        run: |
          echo "=== Running mypy Type Checker ==="
          mypy src/ --ignore-missing-imports || true
        continue-on-error: true

      - name: Run pyright type checker
        run: |
          echo "=== Running pyright Type Checker ==="
          pyright src/ || true
        continue-on-error: true

  syntax-validation:
    name: Python Syntax Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Python syntax
        run: |
          echo "=== Validating Python Syntax ==="
          python -m py_compile src/main.py
          echo "‚úÖ main.py syntax is valid"
          
          for file in src/*.py; do
            if [ -f "$file" ]; then
              python -m py_compile "$file"
              echo "‚úÖ $(basename $file) syntax is valid"
            fi
          done

      - name: Check for syntax errors in tests
        run: |
          echo "=== Validating Test Syntax ==="
          for file in tests/*.py; do
            if [ -f "$file" ]; then
              python -m py_compile "$file"
              echo "‚úÖ $(basename $file) syntax is valid"
            fi
          done

  dependency-check:
    name: Dependency Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check requirements.txt
        run: |
          echo "=== Checking requirements.txt ==="
          if [ -f requirements.txt ]; then
            echo "‚úÖ requirements.txt exists"
            echo "Dependencies:"
            cat requirements.txt
            
            # Try to install dependencies
            pip install --dry-run -r requirements.txt || pip install -r requirements.txt
            echo "‚úÖ Dependencies can be installed"
          else
            echo "‚ùå requirements.txt not found"
            exit 1
          fi

      - name: Check for security vulnerabilities
        run: |
          echo "=== Checking for Security Vulnerabilities ==="
          pip install safety || true
          safety check -r requirements.txt || echo "‚ö†Ô∏è Safety check completed with warnings"
        continue-on-error: true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit vulture xenon

      - name: Run Bandit security linter
        run: |
          echo "=== Running Bandit Security Analysis ==="
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ || true
        continue-on-error: true

      - name: Check for dead code with Vulture
        run: |
          echo "=== Checking for Dead Code ==="
          vulture src/ --min-confidence 80 || true
        continue-on-error: true

      - name: Check code complexity
        run: |
          echo "=== Checking Code Complexity ==="
          xenon --max-absolute B src/ || true
        continue-on-error: true

  test-structure:
    name: Test Structure Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate test files
        run: |
          echo "=== Validating Test Files ==="
          test_count=$(find tests -name "test_*.py" -type f | wc -l)
          echo "Found $test_count test files"
          
          if [ $test_count -eq 0 ]; then
            echo "‚ö†Ô∏è No test files found"
          else
            echo "‚úÖ Found $test_count test files"
          fi

      - name: Check test imports
        run: |
          echo "=== Checking Test Imports ==="
          pip install pytest
          
          for file in tests/test_*.py; do
            if [ -f "$file" ]; then
              python -c "import ast; ast.parse(open('$file').read())" && echo "‚úÖ $(basename $file) imports are valid"
            fi
          done
        continue-on-error: true

  file-structure:
    name: File Structure Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check project structure
        run: |
          echo "=== Checking Project Structure ==="
          
          # Check essential files
          if [ -f src/main.py ]; then
            lines=$(wc -l < src/main.py)
            echo "üìÑ src/main.py: $lines lines"
            
            if [ $lines -gt 10000 ]; then
              echo "‚ö†Ô∏è main.py is very large ($lines lines). Consider modularization."
            fi
          fi
          
          if [ -f README.md ]; then
            echo "‚úÖ README.md exists"
          else
            echo "‚ö†Ô∏è README.md not found"
          fi
          
          if [ -f .gitignore ]; then
            echo "‚úÖ .gitignore exists"
          else
            echo "‚ö†Ô∏è .gitignore not found"
          fi
          
          echo ""
          echo "=== Directory Structure ==="
          find . -type f -name "*.py" | head -20

  summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, syntax-validation, dependency-check, code-quality, test-structure, file-structure]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint and Type Check | ${{ needs.lint-and-type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax Validation | ${{ needs.syntax-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Structure | ${{ needs.test-structure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Structure | ${{ needs.file-structure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.syntax-validation.result }}" == "success" ] && [ "${{ needs.dependency-check.result }}" == "success" ]; then
            echo "‚úÖ **Essential checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some checks failed. Please review.**" >> $GITHUB_STEP_SUMMARY
          fi
