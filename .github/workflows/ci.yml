name: Continuous Integration

on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Build check
        run: |
          echo "=== Build Check ==="
          # Verify all imports work
          python -c "import sys; sys.path.insert(0, 'src'); print('Import path configured')"
          
          # Check for import errors
          python << 'EOF'
          import ast
          import sys
          from pathlib import Path
          
          errors = []
          for py_file in Path('src').rglob('*.py'):
              try:
                  with open(py_file, 'r') as f:
                      ast.parse(f.read())
              except SyntaxError as e:
                  errors.append(f"{py_file}: {e}")
          
          if errors:
              print("Syntax errors found:")
              for err in errors:
                  print(f"  {err}")
              sys.exit(1)
          else:
              print("✅ No syntax errors found")
          EOF

      - name: Run basic smoke tests
        run: |
          echo "=== Smoke Tests ==="
          # Test that we can import the main module (without running it)
          python << 'EOF'
          import sys
          import ast
          from pathlib import Path
          
          main_file = Path('src/main.py')
          if main_file.exists():
              with open(main_file, 'r') as f:
                  content = f.read()
                  tree = ast.parse(content)
                  
              # Count functions and classes
              functions = [node for node in ast.walk(tree) if isinstance(node, ast.FunctionDef)]
              classes = [node for node in ast.walk(tree) if isinstance(node, ast.ClassDef)]
              
              print(f"✅ Parsed main.py successfully")
              print(f"   Functions: {len(functions)}")
              print(f"   Classes: {len(classes)}")
          EOF

      - name: Test file validation
        run: |
          echo "=== Test File Validation ==="
          python -m pytest tests/ --collect-only -q 2>&1 | head -50 || echo "Note: Some tests may require browser dependencies"
        continue-on-error: true

  compatibility-check:
    name: Compatibility Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Python version compatibility
        run: |
          echo "=== Python Version Check ==="
          python_version=$(python --version 2>&1 | awk '{print $2}')
          echo "Current Python version: $python_version"
          
          # Check shebang lines
          if grep -r "#!/usr/bin/env python" src/ --include="*.py" | head -1; then
            echo "✅ Found Python shebang lines"
          fi

      - name: Check dependency versions
        run: |
          echo "=== Dependency Version Check ==="
          if [ -f requirements.txt ]; then
            echo "Dependencies in requirements.txt:"
            cat requirements.txt | grep -v "^#" | grep -v "^$" || true
            
            # Check for unpinned dependencies
            unpinned=$(grep -v "==" requirements.txt | grep -v "^#" | grep -v "^$" || true)
            if [ -n "$unpinned" ]; then
              echo ""
              echo "⚠️  Unpinned dependencies found (consider pinning for reproducibility):"
              echo "$unpinned"
            fi
          fi

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for performance issues
        run: |
          echo "=== Performance Check ==="
          
          # Check for potential performance issues
          echo "Checking for common performance anti-patterns..."
          
          # Check for inefficient string concatenation in loops
          if grep -rn "for.*in.*:" src/ --include="*.py" -A 5 | grep -E "\+=.*['\"].*['\"]" | head -5; then
            echo "⚠️  Potential inefficient string concatenation in loops"
          fi
          
          # Check for sleep in async code (potential blocking)
          if grep -rn "time.sleep" src/ --include="*.py" | grep -v "#" | head -5; then
            echo "⚠️  Found time.sleep - consider using asyncio.sleep for async code"
          fi

  notification:
    name: CI Notification
    runs-on: ubuntu-latest
    needs: [build-and-test, compatibility-check, performance-check]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ needs.build-and-test.result }}';
            const compatStatus = '${{ needs.compatibility-check.result }}';
            const perfStatus = '${{ needs.performance-check.result }}';
            
            const getStatusEmoji = (status) => {
              if (status === 'success') return '✅';
              if (status === 'failure') return '❌';
              return '⚠️';
            };
            
            const body = `## CI Results
            
            | Job | Status |
            |-----|--------|
            | Build and Test | ${getStatusEmoji(buildStatus)} ${buildStatus} |
            | Compatibility Check | ${getStatusEmoji(compatStatus)} ${compatStatus} |
            | Performance Check | ${getStatusEmoji(perfStatus)} ${perfStatus} |
            
            All checks completed. Review the details in the Actions tab.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
